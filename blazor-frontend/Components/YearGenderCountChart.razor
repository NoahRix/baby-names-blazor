@inject HttpClient Http
@inject AppState AppState
@using ApexCharts

<MudPaper Class="pa-4" Style="width: 100%; max-width: 1600px;">
    @if (dataLoaded.Any())
    {
        <ApexChart @ref="chart"
                   TItem="YearGenderData"
                   Title="Gender Count by Year"
                   Height="400"
                   Options="chartOptions">
            
            <ApexPointSeries TItem="YearGenderData"
                             Items="dataLoaded"
                             Name="Male"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.Year)"
                             YValue="@(e => (decimal)e.MaleCount)"
                             Color="#2196F3"
                             ShowDataLabels="false" />
            
            <ApexPointSeries TItem="YearGenderData"
                             Items="dataLoaded"
                             Name="Female"
                             SeriesType="SeriesType.Line"
                             XValue="@(e => e.Year)"
                             YValue="@(e => (decimal)e.FemaleCount)"
                             Color="#FFA726"
                             ShowDataLabels="false" />
        </ApexChart>
    }
    else
    {
        <div Style="height: 400px; display: flex; align-items: center; justify-content: center;">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }
</MudPaper>

@code {
    private ApexChart<YearGenderData>? chart;
    private List<YearGenderData> dataLoaded = new();
    private ApexChartOptions<YearGenderData> chartOptions = new();

    protected override void OnInitialized()
    {
        chartOptions = new ApexChartOptions<YearGenderData>
        {
            Xaxis = new XAxis
            {
                TickAmount = 10,
                
                Labels = new XAxisLabels
                {
                    Rotate = -45,
                    RotateAlways = false
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Formatter = "function(value) { return value.toLocaleString(); }"
                    }
                }
            }
        };
        
        LoadData();
    }

    private void LoadData()
    {
        if (AppState.YearGenderCounts != null && AppState.YearGenderCounts.Any())
        {
            dataLoaded = AppState.YearGenderCounts.Select(x => new YearGenderData 
            { 
                Year = x.Year, 
                MaleCount = x.MaleCount, 
                FemaleCount = x.FemaleCount 
            }).ToList();
            
            Console.WriteLine($"YearGenderCountChart loaded {dataLoaded.Count} data points for state");
        }
        else
        {
            dataLoaded = new List<YearGenderData>();
        }
    }

    public class YearGenderData
    {
        public int Year { get; set; }
        public int MaleCount { get; set; }
        public int FemaleCount { get; set; }
    }
}
