@inject HttpClient Http
@inject AppState AppState

@if (dataLoaded.Any())
{
    <MudPaper Class="pa-4" Style="width: 100%; max-width: 1600px;">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-4">Gender Count by Year</MudText>
                <MudTable Items="@dataLoaded.Take(20)" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>Year</MudTh>
                        <MudTh>Male Count</MudTh>
                        <MudTh>Female Count</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Year">@context.Year</MudTd>
                        <MudTd DataLabel="Male">@context.MaleCount.ToString("N0")</MudTd>
                        <MudTd DataLabel="Female">@context.FemaleCount.ToString("N0")</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCardContent>
        </MudCard>
    </MudPaper>
}

@code {
    private List<YearGenderData> dataLoaded = new();
    private bool hasInitialized = false;

    protected override void OnInitialized()
    {
        AppState.OnChange += OnStateChanged;
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(() =>
        {
            if (AppState.YearGenderCounts != null)
            {
                dataLoaded = AppState.YearGenderCounts.Select(x => new YearGenderData 
                { 
                    Year = x.Year, 
                    MaleCount = x.MaleCount, 
                    FemaleCount = x.FemaleCount 
                }).ToList();
            }
            else
            {
                dataLoaded = new List<YearGenderData>();
            }
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!hasInitialized && AppState.YearGenderCounts != null)
        {
            hasInitialized = true;
            dataLoaded = AppState.YearGenderCounts.Select(x => new YearGenderData 
            { 
                Year = x.Year, 
                MaleCount = x.MaleCount, 
                FemaleCount = x.FemaleCount 
            }).ToList();
        }
    }

    public void Dispose()
    {
        AppState.OnChange -= OnStateChanged;
    }

    public class YearGenderData
    {
        public int Year { get; set; }
        public int MaleCount { get; set; }
        public int FemaleCount { get; set; }
    }
}
