@inject AppState AppState
@inject HttpClient Http
@using blazor_frontend.Services
@implements IDisposable

<div style="width: 100%; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    <div style="position: relative; margin-bottom: 1rem;">
        <MudText Typo="Typo.body1" Align="Align.Center" Style="margin-bottom: 0.5rem;">Select a year</MudText>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <MudText Typo="Typo.caption">@AppState.SelectedStateMinYear</MudText>
            <MudText Typo="Typo.caption">@AppState.SelectedStateMaxYear</MudText>
        </div>
        <MudSlider T="int" 
                   @bind-Value="selectedYear"
                   Min="@(AppState.SelectedStateMinYear ?? 0)"
                   Max="@(AppState.SelectedStateMaxYear ?? 0)"
                   Step="1"
                   TickMarks="true"
                   Color="Color.Primary"
                   Style="width: 100%;"
                   @onmouseup="OnSliderReleased"
                   @ontouchend="OnSliderReleased" />
    </div>
</div>

@code {
    private int selectedYear;

    protected override void OnInitialized()
    {
        selectedYear = AppState.SelectedYear ?? AppState.CommitedYear ?? 0;
        AppState.OnChange += StateHasChanged;
    }

    protected override void OnParametersSet()
    {
        selectedYear = AppState.SelectedYear ?? AppState.CommitedYear ?? 0;
    }

    private async Task OnSliderReleased()
    {
        AppState.SetSelectedYear(selectedYear);
        AppState.SetCommitedYear(selectedYear);

        if (AppState.SelectedState == null || selectedYear == 0)
            return;

        try
        {
            // Fetch both male/female counts and top names
            var countsTask = Http.GetFromJsonAsync<MaleFemaleCountsDto>(
                $"/api/BabyNames/male-female-counts?stateCode={AppState.SelectedState.StateCode}&year={selectedYear}");
            
            var topNamesTask = Http.GetFromJsonAsync<TopPopularMaleFemaleNameCounts>(
                $"/api/BabyNames/top-popular-male-female-name-counts?stateCode={AppState.SelectedState.StateCode}&year={selectedYear}");

            await Task.WhenAll(countsTask, topNamesTask);

            var counts = await countsTask;
            var topNames = await topNamesTask;

            if (counts != null)
            {
                AppState.SetDistinctMaleCountForSelectedState(counts.Item1);
                AppState.SetDistinctFemaleCountForSelectedState(counts.Item2);
            }

            if (topNames != null)
            {
                AppState.SetTopPopularMaleFemaleNameCounts(topNames);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data for year change: {ex.Message}");
        }
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }

    public class MaleFemaleCountsDto
    {
        public int Item1 { get; set; }
        public int Item2 { get; set; }
    }
}
