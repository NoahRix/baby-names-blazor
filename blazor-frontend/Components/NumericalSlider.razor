@inject AppState AppState
@inject HttpClient Http
@using blazor_frontend.Services

<div style="width: 100%; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    <MudSlider T="int" 
               Value="@(AppState.SelectedYear ?? AppState.CommitedYear ?? 0)" 
               ValueChanged="@OnValueChanged"
               Min="@(AppState.SelectedStateMinYear ?? 0)"
               Max="@(AppState.SelectedStateMaxYear ?? 0)"
               Step="1"
               Color="Color.Primary"
               Style="width: 100%;">
        <MudText Typo="Typo.caption" Style="position: absolute; left: 0; bottom: -20px;">@AppState.SelectedStateMinYear</MudText>
        <MudText Typo="Typo.caption" Style="position: absolute; right: 0; bottom: -20px;">@AppState.SelectedStateMaxYear</MudText>
    </MudSlider>
</div>

@code {
    private async Task OnValueChanged(int value)
    {
        AppState.SetSelectedYear(value);
        AppState.SetCommitedYear(value);

        if (AppState.SelectedState == null || value == 0)
            return;

        try
        {
            // Fetch both male/female counts and top names
            var countsTask = Http.GetFromJsonAsync<MaleFemaleCountsDto>(
                $"/api/BabyNames/male-female-counts?stateCode={AppState.SelectedState.StateCode}&year={value}");
            
            var topNamesTask = Http.GetFromJsonAsync<TopPopularMaleFemaleNameCounts>(
                $"/api/BabyNames/top-popular-male-female-name-counts?stateCode={AppState.SelectedState.StateCode}&year={value}");

            await Task.WhenAll(countsTask, topNamesTask);

            var counts = await countsTask;
            var topNames = await topNamesTask;

            if (counts != null)
            {
                AppState.SetDistinctMaleCountForSelectedState(counts.Item1);
                AppState.SetDistinctFemaleCountForSelectedState(counts.Item2);
            }

            if (topNames != null)
            {
                AppState.SetTopPopularMaleFemaleNameCounts(topNames);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data for year change: {ex.Message}");
        }
    }

    public class MaleFemaleCountsDto
    {
        public int Item1 { get; set; }
        public int Item2 { get; set; }
    }
}
