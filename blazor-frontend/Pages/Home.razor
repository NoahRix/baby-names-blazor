@page "/"
@inject AppState AppState

<PageTitle>Baby Names Explorer</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="d-flex flex-column align-center" Style="padding: 2rem 1rem;">
    <MudPaper Elevation="0" Style="width: 100%; max-width: 1200px;">
        <USMap />
        
        @if (AppState.SelectedState != null)
        {
            <div class="d-flex flex-column align-center" Style="margin-top: 1rem;">
                <NumericalSlider />
            </div>
        }
    </MudPaper>

    @if (AppState.SelectedState != null)
    {
        <div Style="width: 100%; max-width: 1200px; margin-top: 2rem;">
            <YearGenderCountChart />
        </div>

        @if (AppState.CommitedYear != null && AppState.TopPopularMaleFemaleNameCounts != null)
        {
            <div class="d-flex justify-center" Style="width: 100%; max-width: 1200px; margin-top: 2rem; gap: 2rem; flex-wrap: wrap;">
                <div Style="flex: 1; min-width: 300px; max-width: 500px;">
                    <MudText Typo="Typo.h6" Align="Align.Center" Style="margin-bottom: 1rem;">
                        Distinct Male Name Count: @AppState.DistinctMaleCountForSelectedState?.ToString("N0")
                    </MudText>
                    <PieChartWithCenterLabel @key="@($"male-{AppState.SelectedState?.StateCode}-{AppState.CommitedYear}")"
                        Title="@($"Top 5 Male Names for {AppState.SelectedState?.StateName}")"
                        Data="@AppState.TopPopularMaleFemaleNameCounts.Male"
                        Gender="Male" />
                </div>
                <div Style="flex: 1; min-width: 300px; max-width: 500px;">
                    <MudText Typo="Typo.h6" Align="Align.Center" Style="margin-bottom: 1rem;">
                        Distinct Female Name Count: @AppState.DistinctFemaleCountForSelectedState?.ToString("N0")
                    </MudText>
                    <PieChartWithCenterLabel @key="@($"female-{AppState.SelectedState?.StateCode}-{AppState.CommitedYear}")"
                        Title="@($"Top 5 Female Names for {AppState.SelectedState?.StateName}")"
                        Data="@AppState.TopPopularMaleFemaleNameCounts.Female"
                        Gender="Female" />
                </div>
            </div>
        }
    }
</MudContainer>

@code {
    protected override void OnInitialized()
    {
        AppState.OnChange += OnStateChanged;
    }

    private async void OnStateChanged()
    {
        await InvokeAsync(() =>
        {
            Console.WriteLine($"Home.OnStateChanged fired - CommitedYear: {AppState.CommitedYear}, SelectedState: {AppState.SelectedState?.StateName}");
            // Just trigger a re-render - all data is already in AppState from USMap
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    public void Dispose()
    {
        AppState.OnChange -= OnStateChanged;
    }
}
